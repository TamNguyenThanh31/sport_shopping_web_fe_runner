<div class="container-fluid">
  <!-- Loading overlay -->
  @if (isLoading) {
    <div class="loading-overlay">
      <p-progressSpinner styleClass="custom-spinner"></p-progressSpinner>
      <p class="loading-text">Đang tải sản phẩm...</p>
    </div>
  }

  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="header-section">
    <div class="header-title">
      <h2>Quản lý sản phẩm</h2>
      <p-button
        label="Thêm sản phẩm"
        icon="pi pi-plus"
        styleClass="p-button-success"
        [routerLink]="['/admin/add-product']"
        *ngIf="canManageProducts()"
      ></p-button>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-toggle">
        <button pButton pRipple icon="pi pi-filter" (click)="toggleFilters()" class="p-button-text p-button-sm">
          {{ showFilters ? 'Ẩn bộ lọc' : 'Hiển thị bộ lọc' }}
        </button>
      </div>
      @if (showFilters) {
        <div class="filter-controls">
          <div class="filter-item">
            <span class="p-input-icon-left">
              <i class="pi pi-search"></i>
              <input pInputText [(ngModel)]="searchQuery" (ngModelChange)="filterBySearch()" placeholder="Tìm kiếm sản phẩm..." class="custom-input">
            </span>
          </div>
          <div class="filter-item">
            <p-dropdown [options]="categories" [(ngModel)]="selectedCategory" optionLabel="name" (onChange)="filterByCategory()" placeholder="Chọn danh mục" styleClass="custom-dropdown"></p-dropdown>
          </div>
          <div class="filter-item">
            <p-dropdown [options]="sortOptions" [(ngModel)]="sortOption" (onChange)="onSortChange()" placeholder="Chọn kiểu sắp xếp" styleClass="custom-dropdown"></p-dropdown>
          </div>
          <div class="filter-item">
            <button pButton pRipple label="Xóa bộ lọc" icon="pi pi-refresh" (click)="resetFilters()" class="p-button-outlined p-button-sm"></button>
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Product List -->
  <div class="product-list">
    <!-- Desktop: Table View -->
    <div class="desktop-view">
      <p-table
        [value]="products"
        [loading]="isLoading"
        [tableStyle]="{'min-width': '50rem'}"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>Hình ảnh</th>
            <th>Tên sản phẩm</th>
            <th>Thương hiệu</th>
            <th>Danh mục</th>
            <th>Giá</th>
            <th>Trạng thái</th>
            <th>Thêm bởi</th>
            <th>Hành động</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product>
          <tr>
            <td data-label="Hình ảnh">
              <img [src]="getPrimaryImage(product.images)" alt="Product image">
            </td>
            <td data-label="Tên sản phẩm">{{ product.name }}</td>
            <td data-label="Thương hiệu">{{ product.brand }}</td>
            <td data-label="Danh mục">{{ getCategoryName(product.categoryId) }}</td>
            <td data-label="Giá">{{ formatPrice(getCurrentPrice(product)) }}</td>
            <td data-label="Trạng thái">{{ product.isActive ? 'Kích hoạt' : 'Không kích hoạt' }}</td>
            <td data-label="Thêm bởi">{{ product.addedById }}</td>
            <td data-label="Hành động">
              <div class="action-buttons">
                <p-button
                  icon="pi pi-pencil"
                  styleClass="p-button-icon p-button-outlined p-button-sm"
                  [routerLink]="['/admin/add-product', product.id]"
                  [queryParams]="{ mode: 'edit' }"
                  *ngIf="canManageProducts()"
                  pTooltip="Sửa"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-trash"
                  styleClass="p-button-icon p-button-danger p-button-sm"
                  (click)="deleteProduct(product.id)"
                  *ngIf="canManageProducts()"
                  pTooltip="Xóa"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  icon="pi pi-eye"
                  styleClass="p-button-icon p-button-info p-button-sm"
                  [routerLink]="['/admin/add-product', product.id]"
                  [queryParams]="{ mode: 'view' }"
                  pTooltip="Chi tiết"
                  tooltipPosition="top"
                ></p-button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center">Không có sản phẩm nào.</td>
          </tr>
        </ng-template>
      </p-table>
      <p-paginator
        [rows]="size"
        [totalRecords]="totalElements"
        [rowsPerPageOptions]="[6, 12, 24]"
        (onPageChange)="onPageChange($event)"
      ></p-paginator>
    </div>

    <!-- Mobile: Card View -->
    <div class="mobile-view">
      <div class="product-cards">
        @for (product of products; track product.id) {
          <div class="product-card">
            <div class="product-image">
              <img [src]="getPrimaryImage(product.images)" alt="Product image">
            </div>
            <div class="product-info">
              <h3>{{ product.name }}</h3>
              <p><strong>Thương hiệu:</strong> {{ product.brand }}</p>
              <p><strong>Danh mục:</strong> {{ getCategoryName(product.categoryId) }}</p>
              <p><strong>Giá:</strong> {{ formatPrice(getCurrentPrice(product)) }}</p>
              <p><strong>Trạng thái:</strong> {{ product.isActive ? 'Kích hoạt' : 'Không kích hoạt' }}</p>
            </div>
            <div class="action-buttons">
              <p-button
                icon="pi pi-pencil"
                styleClass="p-button-icon p-button-outlined p-button-sm"
                [routerLink]="['/admin/add-product', product.id]"
                [queryParams]="{ mode: 'edit' }"
                *ngIf="canManageProducts()"
                pTooltip="Sửa"
                tooltipPosition="top"
              ></p-button>
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-icon p-button-danger p-button-sm"
                (click)="deleteProduct(product.id)"
                *ngIf="canManageProducts()"
                pTooltip="Xóa"
                tooltipPosition="top"
              ></p-button>
              <p-button
                icon="pi pi-eye"
                styleClass="p-button-icon p-button-info p-button-sm"
                [routerLink]="['/admin/add-product', product.id]"
                [queryParams]="{ mode: 'view' }"
                pTooltip="Chi tiết"
                tooltipPosition="top"
              ></p-button>
            </div>
          </div>
        }
        @if (!products.length) {
          <div class="no-products">Không có sản phẩm nào.</div>
        }
      </div>
      <!-- Pagination for mobile -->
      <p-paginator
        [rows]="size"
        [totalRecords]="totalElements"
        [rowsPerPageOptions]="[6, 12, 24]"
        (onPageChange)="onPageChange($event)"
      ></p-paginator>
    </div>
  </div>
</div>
