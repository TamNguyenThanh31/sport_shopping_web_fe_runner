<div class="orders-container">
  <div class="page-header">
    <h2 class="page-title">Lịch sử đơn hàng</h2>
    <div class="order-stats">
      <div class="stat-item">
        <i class="pi pi-shopping-bag"></i>
        <span>{{ orders?.length ?? 0 }} đơn hàng</span>
      </div>
    </div>
  </div>

  <div class="orders-grid">
    <div *ngFor="let order of orders ?? []" class="order-card">
      <div class="order-header">
        <div class="order-id">
          <i class="pi pi-shopping-bag"></i>
          <span>#{{ order?.id }}</span>
        </div>
        <div class="order-date">
          <i class="pi pi-calendar"></i>
          <span>{{ order?.createdAt | date:'short' }}</span>
        </div>
      </div>

      <div class="order-status">
        <div class="status-item">
          <label class="status-label">Trạng thái:</label>
          <span class="status-badge" [ngClass]="order?.status?.toLowerCase()">
            <i class="pi" [ngClass]="{
              'pi-check-circle': order?.status === OrderStatus.DELIVERED,
              'pi-truck': order?.status === OrderStatus.SHIPPED,
              'pi-clock': order?.status === OrderStatus.PENDING,
              'pi-times-circle': order?.status === OrderStatus.CANCELLED,
              'pi-sync': order?.status === OrderStatus.CONFIRMED
            }"></i>
            {{ getStatusText(order?.status) }}
          </span>
        </div>
        <div class="status-item">
          <label class="status-label">Thanh toán:</label>
          <span class="payment-badge" [ngClass]="order?.paymentStatus?.toLowerCase()">
            <i class="pi" [ngClass]="{
              'pi-check-circle': order?.paymentStatus === PaymentStatus.COMPLETED,
              'pi-clock': order?.paymentStatus === PaymentStatus.PENDING,
              'pi-times-circle': order?.paymentStatus === PaymentStatus.FAILED || order?.paymentStatus === PaymentStatus.CANCELLED,
              'pi-refresh': order?.paymentStatus === PaymentStatus.REFUNDED
            }"></i>
            {{ getPaymentStatusText(order?.paymentStatus) }}
          </span>
        </div>
      </div>

      <div class="order-total">
        <span class="total-label">Tổng tiền:</span>
        <span class="total-amount">{{ order?.totalPrice ?? 0 | number : '1.0-0' }} VND</span>
      </div>

      <div class="order-actions">
        <p-button
          icon="pi pi-eye"
          label="Xem chi tiết"
          (click)="viewDetails(order?.id!)"
          styleClass="p-button-rounded p-button-outlined" />
      </div>
    </div>
  </div>

  <p-dialog
    header="Chi tiết đơn hàng"
    [(visible)]="showDetailsDialog"
    [modal]="true"
    [style]="{ 'width': '90vw', 'max-width': '800px' }"
    [draggable]="false"
    [resizable]="false">
    <div *ngIf="selectedOrder" class="order-details">
      <div class="order-timeline">
        <div class="timeline-item" [class.active]="true">
          <div class="timeline-icon">
            <i class="pi pi-shopping-cart"></i>
          </div>
          <div class="timeline-content">
            <h4>Đặt hàng</h4>
            <p>{{ selectedOrder?.createdAt | date:'medium' }}</p>
          </div>
        </div>
        <div class="timeline-item" [class.active]="selectedOrder?.status !== OrderStatus.PENDING">
          <div class="timeline-icon">
            <i class="pi pi-check-circle"></i>
          </div>
          <div class="timeline-content">
            <h4>Xác nhận</h4>
            <p>{{ selectedOrder?.status === OrderStatus.CONFIRMED ? 'Đã xác nhận' : 'Đang chờ xác nhận' }}</p>
          </div>
        </div>
        <div class="timeline-item" [class.active]="selectedOrder?.status === OrderStatus.SHIPPED || selectedOrder?.status === OrderStatus.DELIVERED">
          <div class="timeline-icon">
            <i class="pi pi-truck"></i>
          </div>
          <div class="timeline-content">
            <h4>Giao hàng</h4>
            <p>{{ selectedOrder?.status === OrderStatus.DELIVERED ? 'Đã giao hàng thành công' : 'Đang giao hàng' }}</p>
          </div>
        </div>
      </div>

      <div class="order-info">
        <div class="info-section">
          <h3><i class="pi pi-info-circle"></i> Thông tin đơn hàng</h3>
          <div class="info-grid">
            <div class="info-item">
              <label>Mã đơn hàng</label>
              <span>#{{ selectedOrder?.id }}</span>
            </div>
            <div class="info-item">
              <label>Ngày đặt</label>
              <span>{{ selectedOrder?.createdAt | date:'medium' }}</span>
            </div>
            <div class="info-item">
              <label>Tổng tiền</label>
              <span class="price">{{ selectedOrder?.totalPrice ?? 0 | currency:'VND' }}</span>
            </div>
            <div class="info-item">
              <label>Trạng thái</label>
              <span class="status-badge" [ngClass]="selectedOrder?.status?.toLowerCase()">
                {{ getStatusText(selectedOrder?.status) }}
              </span>
            </div>
            <div class="info-item">
              <label>Thanh toán</label>
              <span class="payment-badge" [ngClass]="selectedOrder?.paymentStatus?.toLowerCase()">
                {{ getPaymentStatusText(selectedOrder?.paymentStatus) }}
              </span>
            </div>
            <div class="info-item">
              <label>Phương thức</label>
              <span>{{ getPaymentMethodText(selectedOrder?.paymentMethod) }}</span>
            </div>
          </div>
        </div>

        <div class="info-section">
          <h3><i class="pi pi-map-marker"></i> Thông tin giao hàng</h3>
          <div class="info-grid">
            <div class="info-item full-width">
              <label>Địa chỉ</label>
              <div class="address-details">
                <i class="pi pi-user"></i>
                <span>{{ selectedOrder?.addressDetails?.fullName }}</span>
                <i class="pi pi-map"></i>
                <span>{{ selectedOrder?.addressDetails?.addressLine }}</span>
                <i class="pi pi-building"></i>
                <span>{{ selectedOrder?.addressDetails?.city }}</span>
              </div>
            </div>
            <div class="info-item">
              <label>Mã giảm giá</label>
              <span class="promo-code">{{ selectedOrder?.promotionCode ?? 'Không có' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="products-section">
        <h3><i class="pi pi-shopping-cart"></i> Sản phẩm</h3>
        <div class="products-grid">
          <div *ngFor="let detail of selectedOrder?.orderDetails ?? []" class="product-card">
            <div class="product-image">
              <img
                [src]="detail?.imageUrl ? 'http://localhost:8080' + detail.imageUrl : 'assets/images/placeholder-product.png'"
                [alt]="detail?.productName" />
            </div>
            <div class="product-info">
              <h4>{{ detail?.productName ?? 'N/A' }}</h4>
              <div class="product-details">
                <span class="detail-item">
                  <i class="pi pi-ruler"></i> {{ detail?.size ?? 'N/A' }}
                </span>
                <span class="detail-item">
                  <i class="pi pi-palette"></i> {{ detail?.color ?? 'N/A' }}
                </span>
                <span class="detail-item">
                  <i class="pi pi-box"></i> Số lượng: {{ detail?.quantity ?? 0 }}
                </span>
              </div>
              <div class="product-price">
                <span class="price-label">Giá:</span>
                <span class="price-value">{{ (detail?.priceAtTime ?? 0) * (detail?.quantity ?? 0) | currency:'VND' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </p-dialog>
</div>
<p-toast />
