<div class="page-wrapper">
  <div class="product-listing-ui">
    <!-- Banner -->
    <div class="banner-ui">
      <p-carousel [value]="banners" [numVisible]="1" [circular]="true" [autoplayInterval]="5000" styleClass="banner-carousel-ui">
        <ng-template pTemplate="item" let-banner>
          <img [src]="banner.imageUrl" [alt]="banner.alt" class="banner-img-ui" />
        </ng-template>
      </p-carousel>
    </div>

    <!-- Sản phẩm bán chạy Carousel -->
    <div class="hot-products-ui">
      <h3 class="hot-title-ui">Sản phẩm bán chạy</h3>
      <p-carousel [value]="hotProducts" [numVisible]="4" [numScroll]="2" [circular]="false" [responsiveOptions]="hotCarouselResponsive" styleClass="hot-carousel-ui">
        <ng-template pTemplate="item" let-product>
          <div class="hot-card-ui">
            <div class="hot-img-box-ui">
              <img [src]="getPrimaryImage(product.images)" [alt]="product.name" class="hot-img-ui" />
              <span class="hot-badge-ui" [ngClass]="{
                'in-stock': hasStock(product),
                'out-of-stock': !hasStock(product),
                'low-stock': getTotalStock(product) > 0 && getTotalStock(product) <= 5
              }">
                {{ getTotalStock(product) === 0 ? 'HẾT HÀNG' : (getTotalStock(product) <= 5 ? 'SẮP HẾT' : 'CÒN HÀNG') }}
              </span>
            </div>
            <div class="hot-name-ui">{{ product.name }}</div>
            <div class="hot-bottom-ui">
              <div class="hot-price-ui">{{ formatPrice(getCurrentPrice(product)) }}</div>
              <div class="hot-actions-ui">
                <button pButton pRipple icon="pi pi-heart" class="hot-action-btn-ui" pTooltip="Yêu thích"></button>
                <button pButton pRipple icon="pi pi-shopping-cart" class="hot-action-btn-ui" [disabled]="!hasStock(product)" (click)="addToCart(product)" pTooltip="Thêm vào giỏ"></button>
              </div>
            </div>
          </div>
        </ng-template>
      </p-carousel>
    </div>

    <div class="main-content-ui">
      <!-- Sidebar (ẩn trên mobile, chuyển lên trên nếu cần) -->
      <aside class="sidebar-ui">
        <div class="search-ui">
          <input
            class="sidebar-search-input"
            [(ngModel)]="searchQuery"
            (ngModelChange)="filterBySearch()"
            placeholder="Tìm kiếm sản phẩm..."
          />
        </div>
        <div class="category-ui">
          <div class="sidebar-title">Danh mục sản phẩm</div>
          <ul class="category-list">
            <li *ngFor="let category of categories" (click)="selectCategory(category)"
                [class.active]="selectedCategory.id === category.id"
                class="category-link">
              <span>{{ category.name }}</span>
              <span class="category-count-ui">{{ categoryProductCounts[category.id] || 0 }}</span>
            </li>
          </ul>
        </div>
        <!-- Có thể thêm filter giá ở đây nếu muốn -->
      </aside>

      <!-- Product List -->
      <section class="products-ui">
        <div class="products-toolbar-ui">
          <div class="toolbar-left-ui">
            <h2>
              {{ selectedCategory.id === 0 ? 'Tất cả sản phẩm' : selectedCategory.name }}
              <span class="product-count-ui">{{ totalElements }} sản phẩm</span>
            </h2>
          </div>
          <div class="toolbar-right-ui">
            <p-dropdown [options]="sortOptions" [(ngModel)]="sortOption" (onChange)="onSortChange()" styleClass="custom-dropdown" placeholder="Sắp xếp theo"></p-dropdown>
            <div class="view-toggle-ui">
              <button pButton pRipple icon="pi pi-th-large" class="view-btn-ui" [ngClass]="{active: viewMode === 'grid'}" (click)="setViewMode('grid')"></button>
              <button pButton pRipple icon="pi pi-list" class="view-btn-ui" [ngClass]="{active: viewMode === 'list'}" (click)="setViewMode('list')"></button>
            </div>
          </div>
        </div>

        <div [ngSwitch]="viewMode">
          <!-- Grid view -->
          <div *ngSwitchCase="'grid'" class="products-grid-ui">
            <ng-container *ngFor="let product of products; trackBy: trackByProductId">
              <div class="product-card-ui">
                <div class="img-box-ui">
                  <img [src]="getPrimaryImage(product.images)" [alt]="product.name" class="img-ui">
                  <span class="badge-ui" [ngClass]="{ 'in-stock': hasStock(product), 'out-of-stock': !hasStock(product) }">
                    {{ hasStock(product) ? 'Còn hàng' : 'Hết hàng' }}
                  </span>
                  <div class="quick-actions-ui">
                    <button pButton pRipple icon="pi pi-heart" class="action-btn-ui" pTooltip="Yêu thích"></button>
                    <button pButton pRipple icon="pi pi-eye" class="action-btn-ui" (click)="openQuickView(product.id!)" pTooltip="Xem nhanh"></button>
                  </div>
                </div>
                <div class="info-ui">
                  <div class="brand-ui">{{ product.brand }}</div>
                  <h3 class="name-ui" (click)="navigateToDetail(product.id!)">{{ product.name }}</h3>
                  <div class="price-ui">{{ formatPrice(getCurrentPrice(product)) }}</div>
                  <div *ngIf="product.variants.length > 1" class="variant-ui">
                    <p-dropdown [options]="product.variants" [(ngModel)]="selectedVariants[product.id!]" (onChange)="onVariantChange(product, $event.value)" optionLabel="sku" styleClass="w-full custom-variant-dropdown" placeholder="Chọn phân loại"></p-dropdown>
                  </div>
                  <button pButton pRipple
                          icon="pi pi-shopping-cart"
                          label="Thêm vào giỏ"
                          (click)="addToCart(product)"
                          [disabled]="!hasStock(product)"
                          class="add-cart-ui"
                          [attr.data-product-id]="product.id">
                  </button>                </div>
              </div>
            </ng-container>
          </div>
          <!-- List view -->
          <div *ngSwitchCase="'list'" class="products-list-ui">
            <ng-container *ngFor="let product of products; trackBy: trackByProductId">
              <div class="product-list-item-ui">
                <img [src]="getPrimaryImage(product.images)" [alt]="product.name" class="img-ui">
                <div class="info-ui">
                  <div class="name-ui" (click)="navigateToDetail(product.id!)">{{ product.name }}</div>
                  <div class="brand-ui">{{ product.brand }}</div>
                  <div class="price-ui">{{ formatPrice(getCurrentPrice(product)) }}</div>
                  <div *ngIf="product.variants.length > 1" class="variant-ui">
                    <p-dropdown [options]="product.variants" [(ngModel)]="selectedVariants[product.id!]" (onChange)="onVariantChange(product, $event.value)" optionLabel="sku" styleClass="w-full custom-variant-dropdown" placeholder="Chọn phân loại"></p-dropdown>
                  </div>
                  <button pButton pRipple
                          icon="pi pi-shopping-cart"
                          label="Thêm vào giỏ"
                          (click)="addToCart(product)"
                          [disabled]="!hasStock(product)"
                          class="add-cart-ui"
                          [attr.data-product-id]="product.id">
                  </button>                </div>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Empty state -->
        <div *ngIf="products.length === 0" class="empty-ui">
          <i class="pi pi-search"></i>
          <h3>Không tìm thấy sản phẩm</h3>
          <p>Thử điều chỉnh bộ lọc hoặc tìm kiếm với từ khóa khác</p>
          <button pButton pRipple label="Xem tất cả sản phẩm" (click)="resetFilters()" class="reset-btn-ui"></button>
        </div>

        <!-- Paginator -->
        <p-paginator [rows]="size" [totalRecords]="totalElements" (onPageChange)="onPageChange($event)" styleClass="custom-paginator" [rowsPerPageOptions]="[12, 24, 36]"></p-paginator>
      </section>
    </div>
    <p-toast position="top-right" key="mainToast"></p-toast>
    <app-quick-view
      [productId]="quickViewProductId"
      [(visible)]="quickViewVisible">
    </app-quick-view>
  </div>
  <app-footer></app-footer>
</div>
