<div class="container-fluid mt-4 ecommerce-container">
  <!-- Loading -->
  <div *ngIf="isLoading" class="text-center p-4">
    <p-progressSpinner styleClass="w-4rem h-4rem"></p-progressSpinner>
    <p class="mt-2">Đang tải sản phẩm...</p>
  </div>

  <!-- Nội dung -->
  <div *ngIf="!isLoading" class="grid">
    <!-- Sidebar: Danh mục -->
    <div class="col-12 md:col-3">
      <div class="category-sidebar">
        <h3 class="category-title">Danh mục sản phẩm</h3>
        <p-listbox
          [options]="categories"
          [(ngModel)]="selectedCategory"
          optionLabel="name"
          (onChange)="filterByCategory()"
          styleClass="w-full"
          [listStyle]="{ 'max-height': '400px' }">
          <ng-template pTemplate="item" let-category>
            <div class="flex justify-content-between align-items-center">
              <span>{{ category.name }}</span>
              <p-badge
                [value]="categoryProductCounts[category.id] || '0'"
                styleClass="ml-2"
                severity="info">
              </p-badge>
            </div>
          </ng-template>
        </p-listbox>
      </div>
    </div>

    <!-- Sản phẩm -->
    <div class="col-12 md:col-9">
      <p-toast position="top-right" key="mainToast"></p-toast>

      <!-- Header: Tìm kiếm, sắp xếp -->
      <div class="product-header flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div class="flex align-items-center gap-3">
          <p-inputText
            [(ngModel)]="searchQuery"
            (ngModelChange)="filterBySearch()"
            placeholder="Tìm kiếm sản phẩm..."
            styleClass="search-input">
          </p-inputText>
          <p class="m-0 text-600">
            {{ filteredProducts.length }} sản phẩm
          </p>
        </div>
        <p-dropdown
          [options]="sortOptions"
          [(ngModel)]="sortOption"
          (onChange)="onSortChange()"
          styleClass="sort-dropdown"
          placeholder="Sắp xếp">
        </p-dropdown>
      </div>

      <!-- Grid sản phẩm -->
      <div class="grid product-grid">
        <div *ngFor="let product of displayProducts" class="col-12 sm:col-6 md:col-4 p-2">
          <p-card styleClass="product-card shadow-2">
            <ng-template pTemplate="header">
              <div class="image-container">
                <img [src]="getProductImage(product)"
                     [alt]="product.name || 'Sản phẩm'"
                     class="product-image">
              </div>
            </ng-template>
            <div class="product-info">
              <h3 class="product-title">{{ product.name || 'Không có tên' }}</h3>
              <p class="product-brand text-600">{{ product.brand || 'N/A' }}</p>
              <p class="product-description">
                {{ product.description ? (product.description | slice:0:60) + '...' : 'Không có mô tả' }}
              </p>
              <div class="flex justify-content-between align-items-center">
                <p class="product-price m-0">{{ getProductPrice(product) }}</p>
                <p-badge
                  [value]="getProductStock(product)"
                  [severity]="getProductStock(product) === '0' || getProductStock(product) === 'N/A' ? 'danger' : 'success'"
                  styleClass="stock-badge">
                </p-badge>
              </div>
            </div>
            <ng-template pTemplate="footer">
              <div class="flex gap-2 product-actions">
                <p-button
                  label="Xem chi tiết"
                  icon="pi pi-eye"
                  styleClass="p-button-outlined p-button-sm detail-button"
                  [routerLink]="['/customer/detail-product', product.id || 0]">
                </p-button>
                <p-button
                  label="Thêm vào giỏ"
                  icon="pi pi-cart-plus"
                  styleClass="p-button-sm cart-button"
                  (click)="addToCart(product)">
                </p-button>
              </div>
            </ng-template>
          </p-card>
        </div>
        <div *ngIf="!displayProducts || displayProducts.length === 0" class="col-12 text-center p-4">
          <p class="text-600 text-lg">Không tìm thấy sản phẩm nào.</p>
        </div>
      </div>

      <!-- Phân trang -->
      <p-paginator
        *ngIf="filteredProducts.length > paginatorRows"
        [rows]="paginatorRows"
        [totalRecords]="filteredProducts.length"
        (onPageChange)="onPageChange($event)"
        [first]="paginatorFirst"
        styleClass="mt-4">
      </p-paginator>
    </div>
  </div>
</div>
