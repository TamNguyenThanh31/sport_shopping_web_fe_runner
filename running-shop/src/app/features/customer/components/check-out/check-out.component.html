<div class="checkout-container">
  <div class="checkout-header">
    <h2>Thanh toán</h2>
    <div class="checkout-steps">
      <div class="step active">Giỏ hàng</div>
      <div class="step active">Thanh toán</div>
      <div class="step">Hoàn tất</div>
    </div>
  </div>

  <div class="checkout-content">
    <div class="order-summary">
      <h3>Đơn hàng của bạn</h3>
      <div class="cart-items">
        <div class="cart-item" *ngFor="let item of cartItems">
          <div class="item-image">
            <img [src]="getImageUrl(item.imageUrl)" [alt]="item.productName" />
          </div>
          <div class="item-details">
            <h4>{{ item.productName }}</h4>
            <div class="item-specs">
              <span class="size">Size: {{ item.size }}</span>
              <span class="color">Màu: {{ item.color }}</span>
            </div>
            <div class="item-price">
              <span class="quantity">Số lượng: {{ item.quantity }}</span>
              <span class="price">{{ item.totalPrice | currency:'VND' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="order-total">
        <div class="total-row">
          <span>Tạm tính:</span>
          <span>{{ subtotal | currency:'VND' }}</span>
        </div>
        <div class="total-row">
          <span>Giảm giá:</span>
          <span class="discount">-{{ discount | currency:'VND' }}</span>
        </div>
        <div class="total-row final">
          <span>Tổng cộng:</span>
          <span>{{ total | currency:'VND' }}</span>
        </div>
      </div>
    </div>

    <div class="checkout-details">
      <div class="section address-section">
        <h3>Địa chỉ giao hàng</h3>
        <div class="selected-address" *ngIf="selectedAddress">
          <div class="address-info">
            <i class="pi pi-map-marker"></i>
            <div>
              <p class="name">{{ selectedAddress.fullName }}</p>
              <p class="address">{{ selectedAddress.addressLine }}, {{ selectedAddress.city }}</p>
              <p class="phone">{{ selectedAddress.phone }}</p>
            </div>
          </div>
          <p-button label="Thay đổi" (click)="showAddressDialog = true" severity="secondary" />
        </div>
        <p-button *ngIf="!selectedAddress" label="Chọn địa chỉ" (click)="showAddressDialog = true" />
      </div>

      <div class="section promotion-section">
        <h3>Mã giảm giá</h3>
        <div class="promotion-info" *ngIf="selectedPromotion">
          <div class="promo-details">
            <i class="pi pi-tag"></i>
            <div>
              <p class="code">{{ selectedPromotion.code }}</p>
              <p class="discount">Giảm {{ selectedPromotion.discountPercentage }}%</p>
            </div>
          </div>
          <div class="promotion-actions">
            <p-button icon="pi pi-times" (click)="removePromotion()" severity="danger" styleClass="p-button-rounded p-button-text" />
            <p-button label="Thay đổi" (click)="showPromotionDialog = true" severity="secondary" />
          </div>
        </div>
        <p-button *ngIf="!selectedPromotion" label="Chọn mã giảm giá" (click)="showPromotionDialog = true" />
      </div>

      <div class="section payment-section">
        <h3>Phương thức thanh toán</h3>
        <div class="payment-options">
          <div class="payment-option" [class.selected]="paymentMethod === 'VNPAY'">
            <p-radioButton name="paymentMethod" value="VNPAY" [(ngModel)]="paymentMethod" />
            <div class="payment-info">
              <i class="pi pi-credit-card"></i>
              <span>Thanh toán qua VNPay</span>
            </div>
          </div>
          <div class="payment-option" [class.selected]="paymentMethod === 'CASH_ON_DELIVERY'">
            <p-radioButton name="paymentMethod" value="CASH_ON_DELIVERY" [(ngModel)]="paymentMethod" />
            <div class="payment-info">
              <i class="pi pi-money-bill"></i>
              <span>Thanh toán khi nhận hàng</span>
            </div>
          </div>
        </div>
      </div>

      <div class="place-order">
        <button class="button-with-icon" (click)="placeOrder()">
          <i class="pi pi-shopping-cart icon"></i>
          <span class="text">Đặt hàng</span>
        </button>
      </div>
    </div>
  </div>
</div>

<p-dialog header="Chọn địa chỉ" [(visible)]="showAddressDialog" [modal]="true" [style]="{ 'width': '50vw' }">
  <div class="address-list">
    <div class="address-card" *ngFor="let address of addresses" (click)="selectAddress(address)">
      <div class="address-content">
        <h4>{{ address.fullName }}</h4>
        <p>{{ address.addressLine }}, {{ address.city }}</p>
        <p>{{ address.phone }}</p>
        <span class="default-badge" *ngIf="address.isDefault">Mặc định</span>
      </div>
    </div>
  </div>
</p-dialog>

<p-dialog header="Chọn mã giảm giá" [(visible)]="showPromotionDialog" [modal]="true" [style]="{ 'width': '50vw' }">
  <div class="promotion-list">
    <div class="promotion-card" *ngFor="let promo of promotions" (click)="applyPromotion(promo)">
      <div class="promo-content">
        <h4>{{ promo.code }}</h4>
        <p>Giảm {{ promo.discountPercentage }}%</p>
        <p *ngIf="promo.minimumOrderValue">Đơn hàng tối thiểu: {{ promo.minimumOrderValue | currency:'VND' }}</p>
        <p *ngIf="promo.endDate">Hết hạn: {{ promo.endDate | date }}</p>
      </div>
    </div>
  </div>
</p-dialog>

<p-toast />
